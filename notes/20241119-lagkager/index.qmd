---
title: "Lagkagediagrammer"
subtitle: "indsæt subtitle"
author: "Christian Knudsen"
visible: "false" # s?t til noget andet n?r opl?gget/noten er f?rdigt
categories:
  - kategori 1
date: 2024-11-19
toc: true
image: ""
---

Jeg er ikke fan af lagkagediagrammer (†). Men lad os kigge på at lave nogen
alligegel.

Vi skal bruge noget data. Og helst noget hvor der ikke er så mange forskellige skiver af lagkagen. To mener jeg er den øvre grænse.

Vi springer til [Danmarks Statistiks statistikbanks api-konsol](https://api.statbank.dk/console#data) og konstruerer et api-kald, hvor vi beder
om antallet af danskere i ordinær beskæftigelse, for hele landet, i 2023, fordelt på alder - og så på køn:

```{r libraries, message = FALSE}
library(tidyverse)
data <- read_csv2("https://api.statbank.dk/v1/data/AMR1/CSV?OMR%C3%85DE=000&KOEN=*%2CK&ALDER1=*&Tid=2023&SOCIO=021")
head(data)
```


Grupper efter køn, summer for at få det samlede antal beskæftigede:

```{r summarising}
tot_data <- data |> 
  group_by(KOEN) |> 
  summarise(antal = sum(INDHOLD))
```

ggplot2 har holdninger til lagkagediagrammer, der ikke er så forskellige fra mine. Så hvis vi skal klare os med 
vanilla ggplot, og ikke hente pakker er det lidt tricky.
Vi laver et stakket barchart - og ændrer koordinaterne til at være polære:

```{r lagkage-1}
tot_data |> 
  ggplot(aes(x="", y = antal, fill = KOEN)) +
  geom_bar(stat = "identity", width = 1, color = "black") +
  coord_polar("y", start = 0)
```

det kan vi godt gøre pænere:
```{r fonthåndtering}
# Find mappen for den AKTUELLE .qmd der knit'es (uanset babelquarto, RStudio, Rscript)
get_input_dir <- function() {
  # 1) Quarto kan sætte denne (afhænger af version/invokation)
  f <- Sys.getenv("QUARTO_INPUT_FILE", "")
  if (nzchar(f)) {
    return(dirname(normalizePath(f, winslash = "/", mustWork = FALSE)))
  }

  # 2) Under knitr/quarto-render: brug den faktiske input-fil
  if (isTRUE(getOption("knitr.in.progress"))) {
    inp <- knitr::current_input()
    if (!is.null(inp) && nzchar(inp)) {
      # gør relativ sti absolut ift. den aktuelle working dir
      if (!grepl("^([A-Za-z]:|/)", inp)) inp <- file.path(getwd(), inp)
      return(dirname(normalizePath(inp, winslash = "/", mustWork = FALSE)))
    }
    # som reserve, hvis current_input() er tom men input.dir er sat
    dir <- knitr::opts_knit$get("input.dir")
    if (!is.null(dir) && nzchar(dir)) {
      return(normalizePath(dir, winslash = "/", mustWork = FALSE))
    }
  }

  # 3) Interaktivt i RStudio
  if (requireNamespace("rstudioapi", quietly = TRUE) && rstudioapi::isAvailable()) {
    p <- tryCatch(rstudioapi::getActiveDocumentContext()$path, error = function(e) "")
    if (nzchar(p)) {
      return(dirname(normalizePath(p, winslash = "/", mustWork = FALSE)))
    }
  }

  # 4) Kørsel via Rscript --file=...
  args <- commandArgs(trailingOnly = FALSE)
  fa <- sub("^--file=", "", args[grepl("^--file=", args)])
  if (length(fa)) {
    return(dirname(normalizePath(fa, winslash = "/", mustWork = FALSE)))
  }

  # 5) Fallback
  normalizePath(getwd(), winslash = "/", mustWork = FALSE)
}

library(showtext)

script_dir <- get_input_dir()  # <- dette er mappen hvor DIN index.qmd ligger
font_file  <- file.path(script_dir, "SEGUISYM.TTF")

if (!file.exists(font_file)) {
  stop("Fandt ikke font: ", font_file,
       "\n(Tjek at SEGUISYM.TTF ligger i samme mappe som den aktuelle .qmd)")
}

font_add("seguisym", font_file)
showtext_auto()



```


```{r}
library(glue)
tot_data |> 
  mutate(andel = antal/sum(antal),
         label = c("♀️", "♂️")) |> 
         mutate(label = c("\u2640", "\u2642")) |> 
  ggplot(aes(x="", y = antal, fill = KOEN, label = label)) +
  geom_bar(stat = "identity", width = 1, color = "white", alpha = 0.7) +
  geom_text(aes(label = glue("{label} \n {scales::percent(andel, accuracy = 1)}"))    ,
          position = position_stack(vjust = 0.5),
          size = 6, 
          family = "seguisym",
          color = "black") +

  labs(title = "Fordeling af ordinært fuldtidsbeskæftigede",
       subtitle = "2023",
       caption = "Danmarks Statistik, Statistikbanken, AMR1") +
      coord_polar("y", start = 0) +
  scale_fill_manual(values = c("Kvinder" = "red", "Mænd" = "blue"), guide = "none") +
  theme_void()
```


```{r facetter}
data |> 
  group_by(ALDER1) |> 
#  filter(ALDER1 == "16-19 år") |> 
  mutate(andel = INDHOLD/sum(INDHOLD),
        label = if_else(KOEN == "Kvinder","\u2640", "\u2642" )) |> 
  ungroup() |> 
ggplot(aes(x="", y = andel, fill = KOEN)) +
  geom_bar(stat = "identity", width = 1, color = "black") +
  coord_polar("y", start = 0) +
  facet_wrap(~ALDER1) +
  geom_text(aes(label = glue("{label} \n {scales::percent(andel, accuracy = 1)}"))    ,
          position = position_stack(vjust = 0.5),
          size = 2 , 
          family = "seguisym",
          color = "black") +

  labs(title = "Fordeling af ordinært fuldtidsbeskæftigede",
       subtitle = "2023",
       caption = "Danmarks Statistik, Statistikbanken, AMR1") +
      coord_polar("y", start = 0) +
  scale_fill_manual(values = c("Kvinder" = "red", "Mænd" = "blue"), guide = "none") +
  theme_void()
```





## (†) Hvorfor hader du lagkagediagrammer? 

Det lagkagediagrammet forsøger at vise er fordelingen - i procent - af et eller andet. Hvis du gerne 
vil vise den procentvise fordeling af noget. Så gør det, gerne i 
den undervurderede metode til at visualisere: Tabellen.

Hvis du gerne vil vise udviklingen. Så lav en graf. Det vi reelt gør
når vi laver et lagkagediagram er at vi mapper en procentvis fordeling
til et antal grader i en cirkel. Vi tror vi viser det med 
et areal. Men i virkeligheden repræsenterer vi værdierne med en
vinkel. Og det er den grafiske variabel vi kan vælge. Som er dårligst
til at vise forskelle. Der er et par klassiske artikler der 
viser det. Og en
nyere, noget større fra Jeffrey Heer og Michael Bostock (og Bostock er
en af guruerne på det her felt). Du kan [finde den her](http://vis.stanford.edu/files/2010-MTurk-CHI.pdf)

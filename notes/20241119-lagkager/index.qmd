---
title: "Lagkagediagrammer"
subtitle: "indsæt subtitle"
author: "Christian Knudsen"
visible: "false" # s?t til noget andet n?r opl?gget/noten er f?rdigt
categories:
  - kategori 1
date: 2024-11-19
toc: true
image: ""
---

Jeg er ikke fan af lagkagediagrammer (†). Men lad os kigge på at lave nogen
alligegel.

Vi skal bruge noget data. Og helst noget hvor der ikke er så mange forskellige skiver af lagkagen. To mener jeg er den øvre grænse.

Vi springer til [Danmarks Statistiks statistikbanks api-konsol](https://api.statbank.dk/console#data) og konstruerer et api-kald, hvor vi beder
om antallet af danskere i ordinær beskæftigelse, for hele landet, i 2023, fordelt på alder - og så på køn:

```{r}
library(tidyverse)
data <- read_csv2("https://api.statbank.dk/v1/data/AMR1/CSV?OMR%C3%85DE=000&KOEN=M%2CK&ALDER1=*&Tid=2023&SOCIO=021")
head(data)
```


Grupper efter køn, summer for at få det samlede antal beskæftigede:

```{r}
tot_data <- data |> 
  group_by(KOEN) |> 
  summarise(antal = sum(INDHOLD))
```

ggplot2 har holdninger til lagkagediagrammer, der ikke er så forskellige fra mine. Så hvis vi skal klare os med 
vanilla ggplot, og ikke hente pakker er det lidt tricky.
Vi laver et stakket barchart - og ændrer koordinaterne til at være polære:

```{r}
tot_data |> 
  ggplot(aes(x="", y = antal, fill = KOEN)) +
  geom_bar(stat = "identity", width = 1, color = "black") +
  coord_polar("y", start = 0)
```

det kan vi godt gøre pænere:
```{r}
library(glue)
tot_data |> 
  mutate(andel = antal/sum(antal),
         label = c("♀️", "♂️")) |> 
  ggplot(aes(x="", y = antal, fill = KOEN, label = label)) +
  geom_bar(stat = "identity", width = 1, color = "black") +
  geom_text(aes(label = glue("{label} \n {scales::percent(andel, accuracy = 1)}"))    ,
          position = position_stack(vjust = 0.5),
          size = 6, color = "black") +
  coord_polar("y", start = 0) +
  ggtitle("Fordeling af ordinært fuldtidsbeskæftigede 2023") +
  theme_void() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 14),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10)
  ) 
  
```





# Opret datasættet
data <- data.frame(
  KØN = c("Mænd", "Kvinder", "Mænd", "Kvinder", "Mænd", "Kvinder", "Mænd", "Kvinder"),
  ALDER = c("35-39 år", "35-39 år", "40-44 år", "40-44 år", "45-49 år", "45-49 år", "50-54 år", "50-54 år"),
  INDHOLD = c(106117, 131599, 134851, 118063, 151005, 134647, 151143, 132615)
)

# Tilføj total for hver aldersgruppe
data <- data %>%
  group_by(ALDER) %>%
  mutate(TOTAL = sum(INDHOLD))

# Plot lagkagediagrammer med facetter
ggplot(data, aes(x = "", y = INDHOLD, fill = KØN)) +
  geom_bar(stat = "identity", width = 1, color = "black") +
  coord_polar("y", start = 0) +
  facet_wrap(~ALDER, ncol = 4) +
  labs(
    title = "Tilknytning til arbejdsmarkedet (fuldtidspersoner)",
    subtitle = "Ordinær beskæftigelse i alt (2022)",
    fill = "Køn"
  ) +
  theme_void() +
  theme(
    strip.text = element_text(size = 12, face = "bold"), # Aldergrupper over diagrammerne
    plot.title = element_text(size = 16, face = "bold"),
    plot.subtitle = element_text(size = 14),
    legend.title = element_text(size = 12),
    legend.text = element_text(size = 10)
  )


library(httr)
library(tidyplots)
library(tidyverse)

library(danstat)
library(ggpie)

danstat::get_table_metadata("AMR2")

variables <- list(list(code = "KØN", values = c("M","K")),
                  list(code = "SOCIO", values = "021"),
                  list(code = "ALDER", values = NA),
                  list(code = "TID", values = 2022))


data <- danstat::get_data("AMR2", variables = variables, language = "da")
data %>% select(-TID) %>% 
  filter(ALDER == "40-44 år") %>% 
  ggplot(aes(x = ALDER, y = INDHOLD, fill = KØN)) +
  geom_bar( stat = "identity") +
  coord_polar("y", start = 0)


## (†) Hvorfor hader du lagkagediagrammer? 

Det lagkagediagrammet forsøger at vise er fordelingen - i procent - af et eller andet. Hvis du gerne 
vil vise den procentvise fordeling af noget. Så gør det, gerne i 
den undervurderede metode til at visualisere: Tabellen.

Hvis du gerne vil vise udviklingen. Så lav en graf. Det vi reelt gør
når vi laver et lagkagediagram er at vi mapper en procentvis fordeling
til et antal grader i en cirkel. Vi tror vi viser det med 
et areal. Men i virkeligheden repræsenterer vi værdierne med en
vinkel. Og det er den grafiske variabel vi kan vælge. Som er dårligst
til at vise forskelle. Der er et par klassiske artikler der 
viser det. Og en
nyere, noget større fra Jeffrey Heer og Michael Bostock (og Bostock er
en af guruerne på det her felt). Du kan [finde den her](http://vis.stanford.edu/files/2010-MTurk-CHI.pdf)
